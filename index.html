<html>
<head>
<title>Transaction Log</title>
<style>
body {
	font-family: Helvetica;
}
.added {
	color: dodgerblue;
}
.removed {
	color: gray;
	text-decoration: line-through;
}
textarea {
	min-width: 30em;
	min-height: 10em;
	margin-right: 30px;
}
</style>
<script src="lib/diff.js"></script>
<script>

var prevText = ""
var textElement1
var logElement


function createDiff(prev, curr) {
	// using the jsdiff library
	// source: https://github.com/kpdecker/jsdiff/

	var res = []
	var diff = JsDiff.diffChars(prev, curr)

	diff.forEach(function(section) {
		var block = document.createElement("span")
		if (section.added) {
			block.className = "added"
		} else if (section.removed) {
			block.className = "removed"
		}

		block.innerText = section.value
		res.push(block)
	})

	return res
}

function logKeystroke(event, carotIndex, user) {
	console.log([event.keyCode, carotIndex, user])
}

function processUpdate() { 
    var updatedText = textElement1.value

	diffSpans = createDiff(prevText, updatedText)

	// add element with diff between prev and updated text
	var logEntry = document.createElement("p")
	diffSpans.forEach(function(span) {
		logEntry.appendChild(span)
	})
	logEntry.appendChild(document.createTextNode(String.fromCharCode(160)))

	logElement.appendChild(logEntry)

	prevText = updatedText
}

document.addEventListener("DOMContentLoaded", function() {
	var buttonElement = document.getElementById("update-button")
	textElement1 = document.getElementById("textarea-1")
	textElement2 = document.getElementById("textarea-2")
	logElement = document.getElementById("log")

	buttonElement.addEventListener("click", processUpdate, false)

	textElement1.addEventListener("keyup", function(e) {
		logKeystroke(e, textElement1.selectionStart, 0)
	}, false)

	textElement2.addEventListener("keyup", function(e) {
		logKeystroke(e, textElement2.selectionStart, 1)
	}, false)
});

</script>
</head>
<body>
<div class="player-1">
	<textarea id="textarea-1"></textarea>
	<textarea id="textarea-2"></textarea>
	<p><button id="update-button">Update</button></p>
</div>
<div id="log"></div>
</body>	
</html>