<html>
<head>
<title>Transaction Log</title>
<style>
body {
	font-family: Helvetica;
}
.added {
	color: dodgerblue;
}
.removed {
	color: gray;
	text-decoration: line-through;
}
textarea {
	min-width: 30em;
	min-height: 10em;
	margin-right: 30px;
}
</style>
<script src="lib/diff.js"></script>
<script>

var currText = "",
	textElement1,
	logElement,
	opLog = []



function createDiff(prev, curr) {
	// using the jsdiff library
	// source: https://github.com/kpdecker/jsdiff/

	var res = []
	var diff = JsDiff.diffChars(prev, curr)

	diff.forEach(function(section) {
		var block = document.createElement("span")
		if (section.added) {
			block.className = "added"
		} else if (section.removed) {
			block.className = "removed"
		}

		block.innerText = section.value
		res.push(block)
	})

	return res
}

function opTransform(prevOp, currOp) {
	if (prevOp.user === currOp.user) {
		return
	}

	// unsure what the accepted best practice for formating large conditionals
	if (prevOp.type === "ins" &&
		currOp.type === "ins" &&
		prevOp.pos <= currOp.pos) {
		currOp.pos += 1
	} else if (prevOp.type === "del" &&
		currOp.type === "ins" &&
		prevOp.pos < currOp.pos) {
		currOp.pos -= 1
	} else if (prevOp.type === "ins" &&
		currOp.type === "del" &&
		prevOp.pos <= currOp.pos) {
		currOp.pos += 1
	} else if (prevOp.type === "del" && currOp.type === "del") {
		if (prevOp.pos < currOp.pos) {
			currOp.pos -= 1
		} else if (prevOp.pos === currOp.pos) {
			// TODO: handle deletion of same char
		}
	}
}

function adjustOps() {
	for (var i = 1; i < opLog.length; i++) {
		for (var j = 0; j < i; j++) {
			opTransform(opLog[j], opLog[i])
		}
	}
}

function applyOps() {
	opLog.forEach(function(op) {
		if (op.type === "ins") {
			currText = currText.slice(0, op.pos) + op.char + currText.slice(op.pos)
		} else if (op.type === "del") {
			currText = currText.slice(0, op.pos) + currText.slice(op.pos + 1)
		}
	})
}

function logKeystroke(event, carotPos, user) {
	// console.log([event.key, carotPos, user])
	var op = new Object()
	op.user = user

	if (event.key === "Delete" || event.key === "Backspace") {
		op.type = "del"
		op.pos = carotPos
		opLog.push(op)
	} else if (event.key.length === 1) {
		op.type = "ins"
		op.pos = carotPos - 1
		op.char = event.key
		opLog.push(op)
	}
}

function processUpdate() { 
	adjustOps()
	applyOps()
	opLog = []

	textElement1.value = currText
	textElement2.value = currText
}

document.addEventListener("DOMContentLoaded", function() {
	var buttonElement = document.getElementById("update-button")
	textElement1 = document.getElementById("textarea-1")
	textElement2 = document.getElementById("textarea-2")
	logElement = document.getElementById("log")

	buttonElement.addEventListener("click", processUpdate, false)

	/* known limitations:
	 *  - does not handle repeat keypress
     *  - does not handle selection deletions
     *  - keystrokes with modifiers aren't ignored
	 */

	textElement1.addEventListener("keyup", function(e) {
		logKeystroke(e, this.selectionStart, 0)
	}, false)

	textElement2.addEventListener("keyup", function(e) {
		logKeystroke(e, this.selectionStart, 1)
	}, false)
});

</script>
</head>
<body>
<div class="player-1">
	<textarea id="textarea-1"></textarea>
	<textarea id="textarea-2"></textarea>
	<p><button id="update-button">Update</button></p>
</div>
<div id="log"></div>
</body>	
</html>