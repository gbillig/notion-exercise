<html>
<head>
<title>Transaction Log</title>
<style>
body {
	font-family: Helvetica;
}
.removed {
	text-decoration: line-through;
}
.user-1 {
	color: dodgerblue;
}
.user-2 {
	color: goldenrod;
}
textarea {
	min-width: 30em;
	min-height: 10em;
	margin-right: 30px;
}
</style>
<script src="lib/diff.js"></script>
<script>

var currText = "",
	textElement1,
	logElement,
	opLog = [],
	state = []



function createDiff(prev, curr) {
	// using the jsdiff library
	// source: https://github.com/kpdecker/jsdiff/

	var res = []

	state.forEach(function(section) {
		var block = document.createElement("span")
		if (section.type != "curr") {
			if (section.user === 0) {
				block.className += "user-1 "
			} else if (section.user === 1) {
				block.className += "user-2 "
			}

			if (section.type === "del") {
				block.className += "removed "
			}
		}

		block.innerText = section.data
		res.push(block)
	})

	return res
}

function opTransform(prevOp, currOp, opIndex) {
	if (prevOp.user === currOp.user) {
		return
	}

	// unsure what the accepted best practice for formating large conditionals
	if (prevOp.type === "ins" &&
		currOp.type === "ins" &&
		prevOp.start <= currOp.start) {
		currOp.start += 1
	} else if (prevOp.type === "del" &&
			   currOp.type === "ins" &&
			   prevOp.start < currOp.start) {
		if (prevOp.end > currOp.start) {
			currOp.start -= currOp.start - prevOp.start
		} else {
			currOp.start -= prevOp.end - prevOp.start
		}
	} else if (prevOp.type === "ins" &&
			   currOp.type === "del" &&
			   prevOp.start <= currOp.start) {
		if (prevOp.start <= currOp.start) {
			currOp.start += 1
			currOp.end += 1
		} else if (prevOp.start > currOp.start) {
			var newOp = new Object()
			newOp.type = "del"
			newOp.user = currOp.user
			newOp.start = prevOp.start + 1
			newOp.end = currOp.end + 1
			opLog.splice(opIndex, 0, newOp)
		}
	} else if (prevOp.type === "del" && currOp.type === "del") {
		if (prevOp.end <= currOp.start) {
			currOp.start -= prevOp.end - prevOp.start
			currOp.end -= prevOp.end - prevOp.start
		} else if (prevOp.start <= currOp.start && prevOp.end > currOp.start) {
			currOp.start = prevOp.start
			currOp.end -= prevOp.end - prevOp.start

			if (currOp.end < currOp.start) {
				currOp.end = currOp.start
			}
		} else if (currOp.start <= prevOp.start && currOp.end > prevOp.start) {
			if (currOp.end <= prevOp.end) {
				currOp.end -= currOp.end - prevOp.start
			} else {
				currOp.end -= prevOp.end - prevOp.start
			}
		}
	}
}

function updateState() {
	for (i = state.length - 1; i >= 0; i--) {
		if (state[i].type === "del") {
			state.splice(i, 1)
		} else {
			state[i].type = "curr"
		}
	}
}

function insertIntoState(value, index) {
	limit = index
	for (i = 0; i < limit; i++) {
		if (state[i].type === "del") {
			limit += 1
		}
	}
	state.splice(i, 0, value)
}

function deleteFromState(user, start, end) {
	for (i = start; i < end; i++) {
		state[i].type = "del"
		state[i].user = user
	}
}

function adjustOps() {
	for (var i = 1; i < opLog.length; i++) {
		for (var j = 0; j < i; j++) {
			opTransform(opLog[j], opLog[i], i)
		}
	}
}

function applyOps() {
	opLog.forEach(function(op) {
		if (op.type === "ins") {
			currText = currText.slice(0, op.start) + op.data + currText.slice(op.start)
			insertIntoState(op, op.start)
		} else if (op.type === "del") {
			currText = currText.slice(0, op.start) + currText.slice(op.end)
			deleteFromState(op.user, op.start, op.end)
		}
	})
}

function logKeystroke(event) {
	// console.log([event.data, event.inputType, event.cancelable])

	var target = event.target
	var user = target.id === "textarea-1" ? 0 : 1
	var carotStart = target.selectionStart
	var carotEnd = target.selectionEnd

	var op = new Object()
	op.user = user

	if (event.inputType === "insertText") {
		if (carotStart != carotEnd) {
			var selectionDelOp = new Object()
			selectionDelOp.user = user
			selectionDelOp.type = "del"
			selectionDelOp.start = carotStart
			selectionDelOp.end = carotEnd
			opLog.push(selectionDelOp)
		}

		op.type = "ins"
		op.start = carotStart
		op.data = event.data
		opLog.push(op)
	} else if (event.inputType === "deleteContentBackward" ||
			   event.inputType === "deleteContentForward") {
		op.type = "del"

		if (carotStart != carotEnd) {
			op.start = carotStart
			op.end = carotEnd
		} else {
			if (event.inputType === "deleteContentBackward") {
				if (carotStart > 0) {
					op.start = carotStart - 1
				} else {
					op.start = 0
				}
				op.end = carotEnd
			} else if (event.inputType === "deleteContentForward") {
				op.start = carotStart
				op.end = carotEnd + 1
			}
		}

		opLog.push(op)
	}
}

function processUpdate() {
	updateState() 
	adjustOps()
	applyOps()

	var diffSpans = createDiff()

	var logEntry = document.createElement("p")
	diffSpans.forEach(function(span) {
		logEntry.appendChild(span)
	})
	logEntry.appendChild(document.createTextNode(String.fromCharCode(160)))
	logElement.appendChild(logEntry)

	textElement1.value = currText
	textElement2.value = currText
	opLog = []
}

document.addEventListener("DOMContentLoaded", function() {
	var buttonElement = document.getElementById("update-button")
	textElement1 = document.getElementById("textarea-1")
	textElement2 = document.getElementById("textarea-2")
	logElement = document.getElementById("log")

	buttonElement.addEventListener("click", processUpdate, false)

	textElement1.addEventListener("beforeinput", logKeystroke, false)
	textElement2.addEventListener("beforeinput", logKeystroke, false)
});

</script>
</head>
<body>
<div class="player-1">
	<textarea id="textarea-1"></textarea>
	<textarea id="textarea-2"></textarea>
	<p><button id="update-button">Update</button></p>
</div>
<div id="log"></div>
</body>	
</html>